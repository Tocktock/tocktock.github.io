<!DOCTYPE html>
<html lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1"
  />

  <title>
     영원 &middot; 웹 개발과 일상
    
  </title>

  
  <link rel="canonical" href="https://tocktock.github.io/" />
  

  <link rel="stylesheet" href="https://tocktock.github.io/public/css/poole.css" />
  <link rel="stylesheet" href="https://tocktock.github.io/public/css/syntax.css" />
  <link rel="stylesheet" href="https://tocktock.github.io/public/css/lanyon.css" />

  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400"
  />

  <link
    rel="apple-touch-icon-precomposed"
    sizes="144x144"
    href="https://tocktock.github.io/public/apple-touch-icon-precomposed.png"
  />
  <link rel="shortcut icon" href="https://tocktock.github.io/public/favicon.ico" />

  <link
    rel="alternate"
    type="application/rss+xml"
    title="RSS"
    href="https://tocktock.github.io/atom.xml"
  />

  <!-- <script>
    (function (i, s, o, g, r, a, m) {
      i["GoogleAnalyticsObject"] = r;
      (i[r] =
        i[r] ||
        function () {
          (i[r].q = i[r].q || []).push(arguments);
        }),
        (i[r].l = 1 * new Date());
      (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m);
    })(
      window,
      document,
      "script",
      "//www.google-analytics.com/analytics.js",
      "ga"
    );
    ga("create", "UA-178749172-1", "auto");
    ga("send", "pageview");
  </script> -->
</head>


  <body>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" />

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item description">
    <p>Developer with Cat</p>
  </div>

  <nav class="sidebar-nav">
    <a
      class="sidebar-nav-item active"
      href="https://tocktock.github.io/"
      >Home</a
    >
                
    <div>
      <a
        class="sidebar-nav-item"
        href="https://tocktock.github.io/about/"
        >About me</a
      >
               
    <div>
      <a
        class="sidebar-nav-item"
        href="https://tocktock.github.io/categories/"
        >Categories</a
      >
      
      <ul class="sidebar-categories">
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/Algorithms"
            >Algorithms (28)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/Jekyll"
            >Jekyll (1)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/elasticsearch"
            >elasticsearch (9)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/NestJS"
            >NestJS (5)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/DevTip"
            >DevTip (1)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/nodejs"
            >nodejs (1)</a
          >
        </li>
        
      </ul>
                                                                   
    </div>

    <a class="sidebar-nav-item" href="https://github.com/Tocktock/tocktock.github.io">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2021. All rights reserved.</p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">영원</a>
            <small>웹 개발과 일상</small>
          </h3>
        </div>
      </div>

      <div class="container content"><div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://tocktock.github.io/nestjs/redux-1/"> Redux 기본서!! (feat. react context hook) </a>
    </h1>

    <span class="post-date">11 Feb 2021</span>

    <h2 id="-redux-는-이렇게-작동합니다">🔨 Redux 는 이렇게 작동합니다.</h2>

<p>기본 Redux 는 간단하게 작용합니다. 중앙화 된 상태저장소가 있고 각각의 컴포넌트들이 그 상태저장소에 접근해서 원하는 것을 가져올 수 있습니다. 자식들에게 상태(state)와 자산(props)을 물려줄 필요는 없습니다.</p>

<p>Redux 를 구성하는 3가지 요소가 있습니다.</p>

<ul>
  <li><strong>Actions</strong></li>
  <li><strong>Store</strong></li>
  <li><strong>Reducers</strong></li>
</ul>

<h2 id="-actions">🙂 Actions</h2>

<p>간단하게 Actions 는 이벤트 데이터 입니다.
데이터는 심플한 Javascript Object 입니다. 다음처럼요.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="nx">REQUEST_ROBOTS_SUCCESS</span><span class="p">,</span>
  <span class="nx">isPending</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">payload</span><span class="p">:</span> <span class="p">{</span>
      <span class="nl">robots</span> <span class="p">:</span> <span class="p">[</span><span class="nx">some</span> <span class="nx">api</span> <span class="nx">call</span> <span class="nx">results</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이 Actions 를 dispatch 라는 함수를 통해 Redux Store 로 보내게 됩니다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">dispatch</span><span class="p">({</span>
  <span class="na">type</span><span class="p">:</span> <span class="nx">REQUEST_ROBOTS_SUCCESS</span><span class="p">,</span>
  <span class="na">isPending</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">payload</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">robots</span> <span class="p">:</span> <span class="p">[</span><span class="nx">some</span> <span class="nx">api</span> <span class="nx">call</span> <span class="nx">results</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="-reducers">🙂 Reducers</h2>

<p>Reducers 는 순수함수입니다. 이전 상태 값을 받아 새로운 상태 값을 리턴하는 함수입니다.</p>

<blockquote>
  <p>순수함수란 값을 받아서 어떤 값을 다시 리턴 해주는 함수이며, 이때 동일한 값을 받으면 그 값에 대해서 항상 같은 값을 리턴해준다면 이를 순수함수라고 합니다..</p>
</blockquote>

<p>dispatch 를 통해 action 을 받은 Reducer 는 action 의 타입에 따라 다른 행동을 합니다.</p>

<p>reqeustBots 라는 Reducer 를 예를 들면,</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">requestRobots</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span><span class="o">=</span><span class="nx">initialStateRobots</span><span class="p">,</span> <span class="nx">action</span><span class="o">=</span><span class="p">{})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="na">REQUEST_ROBOTS_PENDING</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">state</span><span class="p">,</span> <span class="p">{</span><span class="na">isPending</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
    <span class="k">case</span> <span class="na">REQUEST_ROBOTS_SUCCESS</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">state</span><span class="p">,</span> <span class="p">{</span><span class="na">robots</span><span class="p">:</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">,</span> <span class="na">isPending</span><span class="p">:</span> <span class="kc">false</span><span class="p">})</span>
    <span class="k">case</span> <span class="na">REQUEST_ROBOTS_FAILED</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">state</span><span class="p">,</span> <span class="p">{</span><span class="na">error</span><span class="p">:</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">})</span>
    <span class="na">default</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>이처럼 생겼으며 순수함수 이므로 state 를 변화시킨다기 보다는 새로운 state 를 만들어 리턴하게 됩니다.</p>

<h2 id="-store">🙂 Store</h2>

<p>store 는 앱의 state 를 가지고 있는 저장소입니다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">Reducers</span><span class="p">);</span>
</code></pre></div></div>

<p>이 store 를 Redux 의 Provider 를 통해 앱으로 전달하게 됩니다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">Provider</span> <span class="nx">store</span><span class="o">=</span><span class="p">{</span><span class="nx">store</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="sr">/Provider&gt;</span><span class="err">,
</span>  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">root</span><span class="dl">"</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>App 컴포넌트에서는 이 store 에 접근하기 위해 react-redux 라이브러리의 connect 함수를 통해 연결하게 됩니다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mapStateToProps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">searchField</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">searchRobots</span><span class="p">.</span><span class="nx">searchField</span><span class="p">,</span>
    <span class="na">robots</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">requestRobots</span><span class="p">.</span><span class="nx">robots</span><span class="p">,</span>
    <span class="na">isPending</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">requestRobots</span><span class="p">.</span><span class="nx">isPending</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="c1">// dispatch the DOM changes to call an action. note mapStateToProps returns object, mapDispatchToProps returns function</span>
<span class="c1">// the function returns an object then uses connect to change the data from redecers.</span>
<span class="kd">const</span> <span class="nx">mapDispatchToProps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dispatch</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">onSearchChange</span><span class="p">:</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">setSearchField</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)),</span>
    <span class="na">onRequestRobots</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">requestRobots</span><span class="p">()),</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">connect</span><span class="p">(</span><span class="nx">mapStateToProps</span><span class="p">,</span> <span class="nx">mapDispatchToProps</span><span class="p">)(</span><span class="nx">App</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>mapStateToProps : 우리가 이 컴포넌트에서 사용할 state.</li>
  <li>mapDispatchToProps : 우리가 이 컴포넌트에서 사용할 actions 들을 dispatch 할 정보를 담은 함수.</li>
</ul>

<hr />

<h2 id="-redux-middleware">🙂 Redux Middleware</h2>

<p>Redux 에서는 Action 이 dispatch 되기 전 이를 가로채 가공할 수 있는 middleware 기능이 있습니다.</p>

<p>다음과 같이 사용 가능합니다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">thunkMiddleware</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">redux-thunk</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createLogger</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">redux-logger</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span>
  <span class="nx">rootReducers</span><span class="p">,</span>
  <span class="nx">applyMiddleware</span><span class="p">(</span><span class="nx">thunkMiddleware</span><span class="p">,</span> <span class="nx">logger</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>redux-thunk 는 비동기 수행에, redux-logger 는 로그를 남기기 위해 사용하는 middleware 입니다.</p>

<h2 id="-react-context-hook">🙄 React Context hook</h2>

<p>React 의 Context hook 또한 상태 관리를 위한 목적을 가지고 있습니다. Redux 에서와 비슷하게
Provider / Consumer 패턴으로 state 를 제공/ 소비를 할 수 있습니다.</p>

<p>Redux 와 비슷하게 state 를 관리할 수 있습니다. 그럼 왜 Redux 를 아직 사용할까요??</p>

<p>Redux 의 <strong>장점</strong></p>

<ul>
  <li>Debugging 과 Testing 하는데 편리합니다. Redux DevTools 또는 logger 등을 이용한다면 우리 앱에서 컴포넌트의 전환과정 사이에 어떤 일이 일어나는지 알 수 있습니다.</li>
  <li>Redux 는 어떻게 코드가 작성되어야 하는지 강요하는 구조입니다. 큰 규모의 앱에서 관리하기 수월합니다.</li>
  <li>Redux 내부적으로 최적화가 되어있고, 필요한 컴포넌트만 Rerender 할 수 있기 때문에 성능상에서 약간의 이득을 볼 수 있습니다.</li>
  <li>로컬 스토리지에 상태를 영속적으로 저장하고 불러오는데 뛰어납니다.</li>
  <li>초기 상태를 서버에 전송하여 필요한 컴포넌트를 render 할 수 있습니다. 따라서 SSR 에 강점이 있습니다.</li>
</ul>

<p>위의 장점이 필요 없다면 React hooks 만 써도 됩니다.
필요 이상의 일을 할 필요가 없어지는 것 입니다.</p>

<p>그래서 모든 개발자가 React hooks 가 Redux 를 대체할 수 있나요? 라는 질문에
“아니요” 라고 대답하는 것 같습니다.</p>

<p>다만 React hooks 또는 React 관련 기능이 더 성장한다면 Redux 를 대체할 수도 있지 않을까 생각합니다.</p>

<hr />

<p>참고 :</p>

<ul>
  <li><a href="https://blog.logrocket.com/why-use-redux-reasons-with-clear-examples-d21bffd5835/">https://blog.logrocket.com/why-use-redux-reasons-with-clear-examples-d21bffd5835/</a></li>
  <li><a href="https://www.ibrahima-ndaw.com/blog/7-steps-to-understand-react-redux/#2-what-is-redux-and-why-we-need-it">https://www.ibrahima-ndaw.com/blog/7-steps-to-understand-react-redux/#2-what-is-redux-and-why-we-need-it</a></li>
  <li>https://blog.asayer.io/do-you-really-need-redux-pros-and-cons-of-this-state-management-library</li>
  <li>Udemy 강의 - The Complete Junior to Senior Web Developer Roadmap (2021)</li>
</ul>

<p>참고 예제 :</p>

<ul>
  <li><a href="https://github.com/gothinkster/react-redux-realworld-example-app">https://github.com/gothinkster/react-redux-realworld-example-app</a></li>
  <li><a href="https://github.com/aneagoie/robofriends-redux">https://github.com/aneagoie/robofriends-redux</a></li>
</ul>

    <hr />
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://tocktock.github.io/nestjs/nestjs-4-testing/"> NestJS 블로그 만들기 - 리팩토링과 e2e 테스트!! </a>
    </h1>

    <span class="post-date">09 Feb 2021</span>

    <h1 id="2-nestjs-블로그-만들기---리팩토링과-e2e-테스트">2. NestJS 블로그 만들기 - 리팩토링과 e2e 테스트!!</h1>

<p>이번에는 이전 포스트에서 다뤘던 내용에 대해서 Refactoring 을 하고 테스트도 해보겠습니다.</p>

<h2 id="-refactoring-">🔨 Refactoring !!</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└─modules
    └─user
        │  user.controller.ts
        │  user.module.ts
        │  user.repository.ts
        │  user.service.ts
        │  user.spec.ts
        │
        ├─dto
        │      create-user.dto.ts
        │      index.ts
        │      update-user.dto.ts
        │
        ├─entities
        │      user.entity.ts
        │
        ├─exceptions
            email-already-exist-exception.ts
            user-not-found.exception.ts
            username-already-exist-exception.ts
</code></pre></div></div>

<p>계속 리팩토링 하다보니 위와 같은 구조가 만들어졌습니다.
파일 이름이 바뀐 것도 있고, 내부 구현사항이 바뀐 것도 있습니다.
리팩토링 하면서 설계의 중요성을 다시 느낍니다.</p>

<h3 id="userexceptions">user.exceptions</h3>

<p>Custom Exception 을 만들기 위해 user 폴더 안에 exceptions 폴더를 만듭시다!</p>

<p>이메일과 유저네임이 중복 되었을 때 그리고 유저를 찾지 못했을 때 발생 시킬 exception 을 각각 만들어 줍시다.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">username-already-exist-exception.ts</code></li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BadRequestException</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsernameAlreadyExistException</span> <span class="kd">extends</span> <span class="nx">BadRequestException</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">error</span><span class="p">?:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="dl">"</span><span class="s2">username already exist</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">email-already-exist-exception.ts</code></li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BadRequestException</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">EmailAlreadyExistException</span> <span class="kd">extends</span> <span class="nx">BadRequestException</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">error</span><span class="p">?:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="dl">"</span><span class="s2">email already exist</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">user-not-found.exception.ts</code></li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BadRequestException</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">UserNotFoundException</span> <span class="kd">extends</span> <span class="nx">BadRequestException</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">error</span><span class="p">?:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="dl">"</span><span class="s2">user not found</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>각각의 클래스는 BadRequestException 을 상속받고 있습니다.
해당 Exception 을 발생시키면 Status Code 는 400(BadRequest) 이 발생됩니다.</p>

<p>매우 간단하게 Custom Exception 을 만들었습니다!!</p>

<h3 id="userservice">user.service</h3>

<p>create 메소드 안에서 이전에 만들었던 QueryBuilder 부분을 삭제하고 바로 위에서 만들었던 Custom Exceptions 들을 사용하여 간단하게 만들어줍니다.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">UserService.create</code></li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">thisUser</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">});</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">thisUser</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">UserName is already exist</span><span class="dl">"</span><span class="p">;</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nx">UsernameAlreadyExistException</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">thisEmail</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">email</span> <span class="p">});</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">thisEmail</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Email is already exist</span><span class="dl">"</span><span class="p">;</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nx">EmailAlreadyExistException</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>그리고 유저를 저장하여 반환할 때 단순 number 값이 아니라 Object 를 반환해줍시다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="k">return</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">};</span>
</code></pre></div></div>

<p>테스트를 위해 remove 메소드 안의 내용을 다음과 같이 만들어 줍시다.</p>

<blockquote>
  <p>이후 Auth 관련 기능을 만들면서 remove 기능은 사라질겁니다…</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">UserService.remove</code></li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="nx">remove</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">DeleteResult</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="k">delete</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">email</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="usercontroller">user.controller</h3>

<p>remove 와 관련된 controller 부분을 다음으로 변경해주세요!</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">UsersController.remove</code></li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">@</span><span class="nd">Delete</span><span class="p">(</span><span class="dl">''</span><span class="p">)</span>
  <span class="nx">remove</span><span class="p">(@</span><span class="nd">Body</span><span class="p">(</span><span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">)</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">usersService</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@Body</code> annotation 은 response body 안에서 해당하는 필드를 가져와 변수에 입력해주는 기능을 합니다!!</p>

<h2 id="새해-첫-테스트-두근두근">🧡🧡새해 첫 테스트 두근두근</h2>

<p>먼저 유닛테스트가 아닌, e2e 테스트를 진행하기 위한 코드임을 알려드립니다.
테스트 관련 기술이 많이 부족해서 계속 공부중입니다. ㅜㅜ 더 알아가면서 포스트를 업데이트 하도록 하겠습니다!!</p>

<p>테스트는 해당 url 로 요청 수행시 적절한 응답이 오는 확인합니다.</p>

<p>e2e 테스트 방법에 정석이 있겠지만 진행 도중 많은 오류가 발생하여.. 일단 야매로 진행하겠습니다.</p>

<p><strong>서버실행 -&gt; url로 요청</strong></p>

<p>요청을 수행하기 위해서 supertest 라이브러리를 먼저 설치합시댜!!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">--save-dev</span> supertest
</code></pre></div></div>

<blockquote>
  <p>supertest 관한 내용은 다음링크에서 더 확인 가능합니다!!
<a href="https://www.npmjs.com/package/supertest">npm supertest</a></p>
</blockquote>

<p>그리고 테스트 하기 위한 nest 라이브러리도 설치합시다 !!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm i <span class="nt">--save-dev</span> @nestjs/testing
</code></pre></div></div>

<p>이제 user.spec.ts 라는 파일을 user 폴더 안에 생성하여 다음과 같은 코드를 작성합시다!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">request</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">supertest</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:3000</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">User create 테스트</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">).</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test1@example.com</span><span class="dl">"</span> <span class="p">});</span>
    <span class="k">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">).</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test2@example.com</span><span class="dl">"</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">email 중복 확인</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test1@example.com</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">username</span><span class="p">:</span> <span class="dl">"</span><span class="s2">testuser</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">12345</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test1@example.com</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">username</span><span class="p">:</span> <span class="dl">"</span><span class="s2">abcd</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">12345</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Email is already exist</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">username 중복 확인</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test2@example.com</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">username</span><span class="p">:</span> <span class="dl">"</span><span class="s2">testuser</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">12345</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="na">email</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test1@example.com</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">username</span><span class="p">:</span> <span class="dl">"</span><span class="s2">testuser</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">12345</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UserName is already exist</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">describe</code> 메소드로 테스트 할 놈들을 그룹화 해줍니다.</li>
  <li><code class="language-plaintext highlighter-rouge">beforeEach</code> 메소드를 통해 각 테스트를 수행하기 전 테스트 유저를 삭제해줍니다.</li>
  <li><code class="language-plaintext highlighter-rouge">it</code> 메소드를 통해 각각 테스트를 수행합니다. <code class="language-plaintext highlighter-rouge">it</code> 은 <code class="language-plaintext highlighter-rouge">test</code> 메소드와 같은 기능을 하며 별칭입니다.</li>
</ul>

<p>자 이제 테스트를 시작해봅시다!!</p>

<p>먼저 서버실행!!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run start
</code></pre></div></div>

<p>그리고 테스트도 실행 !!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run <span class="nb">test</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; nestjs-practice@0.0.1 test C:\Users\jiyoung\nestjs-practice
&gt; jest

PASS  src/modules/user/user.spec.ts
User create 테스트
    √ email 중복 확인 (173 ms)
    √ username 중복 확인 (24 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        1.392 s, estimated 5 s
Ran all test suites.
</code></pre></div></div>

<p>다음과 같이 통과하면 성공입니다!!</p>

<blockquote>
  <p>package.json 에서 jest 관련 설정을 spec 또는 test 가 붙은 ts 파일로 설정했기 때문에 해당하는 파일은 모두 테스트하게 됩니다!!</p>
</blockquote>

<hr />

<p>테스트 관련해서는 아직 공부하고 있습니다 !!
e2e 테스트를 먼저 해보기 위해 시도는 많이 했으나 그만큼 오류가 많이 나더군요 ㅜㅜ
위와 같은 야매 방법을 통해 테스트를 했으나, 이후에 해결방법을 알아와서 포스트를 업데이트 하겠습니다!!</p>

<p>또한 이후에는 Unit Test 관련 기능도 알아보겠습니다!</p>

<p>다음에는 post 모듈을 만들어봅시다!!
감사합니다.</p>

<p>피드백은 항상 환영입니다.</p>

    <hr />
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://tocktock.github.io/nodejs/nodejs-1-what-is-nodejs/"> Node.js 의 특징과 한계 </a>
    </h1>

    <span class="post-date">01 Feb 2021</span>

    <h2 id="-nodejs-등장하다">🤗 Node.JS 등장하다!!</h2>

<p>초기 웹 페이지는 지금처럼 동적이지 않고 정적이었습니다.
그런데 동적으로 좀 움직이면 좋겠는데.. 하고 나온 것이 Javascript 입니다.
Javascript Javascript 는 브라우저의 자바스크립트 엔진을 통해 DOM Context 를 제어하며 동적인 웹페이지를 만들 수 있었습니다.</p>

<p>시간이 흘러 2008 년 구글이 크롬을 발표하면서 V8 자바스크립트 엔진을 만들게 됩니다.
이전과는 다르게 상당한 수준의 퍼포먼스를 보이며 자바스크립트를 다른 분야에 적용하자는 의견이 생기기 시작했습니다. 이후 CommonJS 표준이 발표되고 곧바로 CommonJS 와 V8 엔진을 기반으로 Node.js 가 탄생합니다.</p>

<h2 id="-nodejs-가-빛나기-시작했어">😊 Node.js 가 빛나기 시작했어!!</h2>

<p>Node.js 는 다음과 같은 특징을 가지고 있습니다.</p>

<ul>
  <li>None Blocking</li>
  <li>Event Driven</li>
  <li>Data Intensive</li>
  <li>I/O Intensive</li>
</ul>

<p>사실 위의 특징 모두 Node.js 의 비동기 이벤트 기반 아키텍처 때문입니다.</p>

<h2 id="-쓰레드-기반-vs-비동기-이벤트-기반">😃 쓰레드 기반 vs 비동기 이벤트 기반</h2>

<p>Node.js 가 개발된 배경과 목적에는 다수의 연결을 효율적으로 관리하고 비용을 최소화 할 수 있는 방법을 제시하는 것이 있었습니다. 이를 설명하기 위해 기존의 Multi Thread 환경에 대해서 알아봅시다.</p>

<p>Multi Thread 기반의 서버는 클라이언트가 웹 서버에 요청을 하게 되면 서버에서는</p>

<ul>
  <li>일정한 메모리 공간을 사용해 새로운 Thread 를 생성하거나 또는</li>
  <li>Thread pool 에서 적당한 Thread 를 해당 요청에 할당하게 됩니다.</li>
</ul>

<p>이 할당된 Thread 는 해당 요청이 완료될 때 까지 이 요청에 할당됩니다. 하지만 실제로 코드가 수행되는 속도와 I/O 장치의 수행 속도가 다르기 때문에 Blocking I/O 에 대한 문제가 생기게 됩니다.</p>

<p>Blocking I/O 자체가 발생시키는 문제는</p>

<ul>
  <li>I/O 요청을 하고 응답이 올 때까지 아무것도 하지 않고 시간을 낭비하는 것과</li>
  <li>스케쥴링 처리와 문맥 전환시 CPU 연산이 필요하기 때문에</li>
</ul>

<p>쓰레드가 많아질 수록 이로 인한 성능 저하가 일어난다는 것 입니다.</p>

<p>Node.js 는 Single Thread 기반으로 작동합니다.</p>

<p>뭐 ?? <strong>Single Thread 면 요청 기다리는 동안 아무것도 못하잖아!!</strong></p>

<p>오.. 오해입니다!!</p>

<p>Node.js 는 <strong>Single Thread 기반 비동기 처리 방식</strong> 으로 구동됩니다.</p>

<p>Node.js 는</p>

<ul>
  <li>I/O 작업 처리에 대한 응답을 기다리지 않고 바로 다음 작업을 실행합니다.</li>
  <li>대신 I/O 작업이 종료되면 이벤트를 발생시키고,</li>
  <li>이 이벤트는 해당 프로세스의 이벤트 큐에 등록되게 됩니다.</li>
  <li>노드가 이 이벤트 큐를 주기적으로 계속 감지하여 해당 이벤트 이후 수행해야 할 작업을 하게 됩니다.</li>
</ul>

<p><strong>이벤트 루프</strong> 는 작업을 요청하면서 그 작업이 완료되었을 때 어떤 작업을 진행할지에 대한 콜백함수를 지정하여 동작이 완료되었을 때 해당 콜백함수를 실행하는 동작 방식을 말합니다. 만약 HTTP 요청이 서버에 오면 이벤트 루프는 이를 감지하고 적당한 Worker Thread 를 생성하여 해당 요청을 할당한 후 다른 요청을 기다리게 됩니다.</p>

<p>다시 말해 이벤트 루프는 어떤 요청이 발생하면 그 작업에 대해 <strong>쓰레드 실행만을 일으킬 뿐</strong>입니다. 이후 작업을 할당받았던 해당 쓰레드가 모든 작업을 마치면 미리 전달받은 콜백 함수를 실행하도록 이벤트 루프로 응답하게 되며 이벤트 루프는 이것을 실행하여 클라이언트에게 결과를 응답해줍니다.</p>

<h2 id="-nodejs-의-한계">🙀 Node.js 의 한계</h2>

<p>Node.js : <strong>Culculte Intensive</strong> 한 분야는 자신 없어!!</p>

<p>다음과 같은 상황을 봅시다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100000000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
</code></pre></div></div>

<p>감이 오십니까??</p>

<p>다시 말하자면 Node.js 는 Single Thread 기반입니다. 위 상황과 같이 긴 시간이 필요한 연산이 있으면 거기서 Block 이 됩니다.</p>

<p>반면 Multi Thread 기반의 어떤 Thread 가 위와 같은 요청을 받고 연산을 한다해도 여러 Thread 가 있으니 다른 요청을 받을 수 있습니다.</p>

<blockquote>
  <p>Thread 는 시분할 또는 특정 조건에 해당하는 기간동안 수행되고 Context Switching 을 통해 작업을 미루게 됩니다.</p>
</blockquote>

<p>따라서 단순히 연산에 집중적인 분야에 대해서는 Node.js 가 아닌 다른 언어 다른 코드로 작성하는 방법으로 우회하시는게 좋습니다.</p>

<hr />

<h2 id="-마치며">😭 마치며</h2>

<p>사실 Node.js 환경을 사용하면서, 단순히 백엔드랑 프론트엔드 둘 다 사용가능하니까 !! 라는 지식만 가지고</p>

<p>왜 Node.js 가 무엇을 목적으로 탄생했는지 어떤점에 강점을 가지는지에 대해서는 몰랐던것 같습니다.
생각보다 Performance 도 훌륭하다는 것에 놀랐고 Single Thread 의 비동기 이벤트 기반 수행과정에 다시 놀랐습니다.
최소한 왜 쓰는지 이 환경의 장점이 무엇인지는 아는 것이 중요한 것 같습니다.</p>

<blockquote>
  <p>Node.js 직군 면접을 보면서 특히 더 많이 느꼇습니다.</p>
</blockquote>

<p>추가로, Node.js 도 어떤 부분에서는 Multi Thread 요소를 쓰기도 합니다.
이 부분에 대해서는 다른 내용과 함께 더 좋은 정보를 가지고 다시 찾아뵙겠습니다.!!</p>

<p>출처</p>

<ul>
  <li><a href="https://zbulletjournal.tistory.com/85">https://zbulletjournal.tistory.com/85</a></li>
  <li><a href="https://m.blog.naver.com/hhw1990/221394005779">https://m.blog.naver.com/hhw1990/221394005779</a></li>
  <li><a href="https://www.youtube.com/watch?v=UCd6LorxpkY&amp;list=PLqq-6Pq4lTTa-d0iZg41U2RDqECol9C5B&amp;index=6">https://www.youtube.com/watch?v=UCd6LorxpkY&amp;list=PLqq-6Pq4lTTa-d0iZg41U2RDqECol9C5B&amp;index=6</a></li>
  <li><a href="https://sjh836.tistory.com/149">https://sjh836.tistory.com/149</a></li>
  <li><a href="https://edu.goorm.io/learn/lecture/557/%ED%95%9C-%EB%88%88%EC%97%90-%EB%81%9D%EB%82%B4%EB%8A%94-node-js">https://edu.goorm.io/learn/lecture/557/%ED%95%9C-%EB%88%88%EC%97%90-%EB%81%9D%EB%82%B4%EB%8A%94-node-js</a></li>
</ul>

    <hr />
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://tocktock.github.io/nestjs/nestjs-3-database/"> NestJS 블로그 만들기 - 데이터베이스 연결 </a>
    </h1>

    <span class="post-date">01 Feb 2021</span>

    <h1 id="2-nestjs-블로그-만들기---데이터베이스-연결-postgresql과-user-모듈">2. NestJS 블로그 만들기 - 데이터베이스 연결 (Postgresql)과 User 모듈</h1>

<hr />

<blockquote>
  <p>저는 오늘 포스팅할 분량의 앱을 만든 후 블로그 포스팅하기 때문에 중간에 오류가 생길 수도 있습니다.
오류 내용과 함께 댓글을 달아주시면 저도 알아보겠습니다!!</p>
</blockquote>

<h2 id="-데이터-베이스-연결하기-">👌 데이터 베이스 연결하기 !!</h2>

<h3 id="postgresql-설치">PostgreSQL 설치!!</h3>

<p>여러분 드디어 데이터베이스에 연결할 시간이 왔습니다!!.
실제 연습할 때는 배열 같은 임의 적인 놈을 만들고 나서 하긴하지만… 바로 연결해보죠!</p>

<p>저희는 Postgresql 을 사용할 겁니다!! 다른 데이터베이스를 사용하셔도 됩니다!!</p>

<blockquote>
  <p>Postgresql 은 오픈소스 데이터베이스로 SQL 표준을 잘 지원합니다. 일단 무료입니다!!
설치하는 방법은 정식 문서나 타 블로그 포스트를 참조해주세요. <a href="https://junlab.tistory.com/177">postgresql 설치방법</a></p>
</blockquote>

<p>편의를 위해 pgAdmin 툴을 이용하여 postgresql 을 제어하겠습니다.!!</p>

<p>기존의 서버 (PostgreSQL 13 이군요 저는) 를 우클릭하여 데이터베이스를 만듭시다!!
저는 데이터베이스 이름을 <code class="language-plaintext highlighter-rouge">nest_blog</code> 라고 했습니다!!</p>

<blockquote>
  <p>원하시는 서버를 만들고 데이터베이스를 생성하셔도 괜찮습니다.</p>
</blockquote>

<p>데이터베이스의 스키마 구조에 대해서는 아직 정의하지 않겠습니다. NestJS가 해줄거거든요!!</p>

<h3 id="typeorm-">TypeORM !!</h3>

<p>TypeORM 은 NodeJS 환경에서 사용할 수 있는 ORM (Object Relational Mapping) 라이브러리 입니다!!</p>

<blockquote>
  <p>ORM 은 간단히 말해 Object 를 Database 스키마에 적절하게 적용시키게 해주는 기능이라 생각하면 편합니다.!!</p>
</blockquote>

<p>설치 설치~ nestjs 루트 폴더에서 다음 명령어로 설치해주세요 !!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nv">$ </span>npm <span class="nb">install </span>typeorm @nestjs/typeorm <span class="nt">--save</span>
</code></pre></div></div>

<p>설치가 됬으면 <code class="language-plaintext highlighter-rouge">ormconfig.json</code> 이라는 파일을 루트 폴더에 만들어 줍니다.
나중에 TypeORM 모듈이 이 파일을 참고해 데이터베이스에 연결을 시도합니다!!</p>

<p>다음과 같이 입력해주세요!!</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">5432</span><span class="p">,</span><span class="w">
  </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="err">여러분이</span><span class="w"> </span><span class="err">설정했던</span><span class="w"> </span><span class="err">비밀번호!</span><span class="p">,</span><span class="w">
  </span><span class="nl">"database"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nest_blog"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"entities"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"dist/**/**.entity{.ts,.js}"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"synchronize"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">type</code> : 우리가 사용하게 될 데이터베이스 시스템을 나타냅니다.</li>
  <li><code class="language-plaintext highlighter-rouge">host</code> : db 연결 주소입니다. 기본적으로 <code class="language-plaintext highlighter-rouge">localhost</code> 를 이용하고 db 를 다른 머신에서 실행한다면 그 머신에 접속하기 위한 주소로 변경해주시면 됩니다.</li>
  <li><code class="language-plaintext highlighter-rouge">port</code> : db 연결 포트 입니다. 기본은 <code class="language-plaintext highlighter-rouge">5432</code> 입니다.</li>
  <li><code class="language-plaintext highlighter-rouge">username</code> : 별 다른 설정을 안했다면 <code class="language-plaintext highlighter-rouge">postgres</code> 입니다</li>
  <li><code class="language-plaintext highlighter-rouge">password</code> : 설치 과정에서 설정했던 비밀번호를 입력하세요.</li>
  <li><code class="language-plaintext highlighter-rouge">database</code> : 위에서 만들었던 데이터베이스의 이름을 입력하시면 됩니다. 저는 <code class="language-plaintext highlighter-rouge">nest_blog</code> 라고 했습니다.</li>
  <li><code class="language-plaintext highlighter-rouge">entities</code> : 반드시 <code class="language-plaintext highlighter-rouge">dist</code> 아래의 폴더로 지정해주세요. 안그러면 오류날 수도 있습니다. 이 설정의 경로에 있는 파일을 참고하여 DB 에서 스키마를 설정하게 됩니다.</li>
  <li><code class="language-plaintext highlighter-rouge">synchronize</code> : 이 설정을 true 로 하시면 앱 작동시 DB 스키마가 자동으로 생성되게 됩니다.</li>
</ul>

<blockquote>
  <p>자세한 내용은 <a href="https://typeorm.io/#/using-ormconfig">ormconfig 탐방하기!!</a> 을 참조해주세요~</p>
</blockquote>

<h3 id="app-모듈에서-import--그리고-실행">app 모듈에서 import !! 그리고 실행!!</h3>

<p>자 이제 <code class="language-plaintext highlighter-rouge">app.moudle.ts</code> 파일로 가서 TypeOrmMoudle 을 import 해줍시다!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersModule</span><span class="p">,</span> <span class="nx">TypeOrmModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">()],</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppService</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ormconfig.json</code> 파일을 생성하지 않았다면, forRoot 함수 안에 설정 내용을 적으셔야 합니다.!!
파일로 관리하는게 더 편하겠죠~?</p>

<p>자 이제 루트 폴더에서 다음과 같은 명령어를 수행해봅시다!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run start
</code></pre></div></div>

<p>별 다른 오류가 없다면 정상적으로 연결 된겁니다!! 우라하!!!
저희는 아직 Entity에 대해서 설정을 하지 않았기 때문에 테이블에 별 내용은 없습니다.</p>

<p>이후에 Entity 를 만든 후에는 DB 에서 테이블을 삭제하고 다시 연결해주시면 만든 내용이 적용됩니다!</p>

<h2 id="-user-entity-만들기">🛴 User Entity 만들기.</h2>

<p>톡.</p>

<p>DB 도 연결했겠다.</p>

<p>톡톡.</p>

<p>User Entity Template 도 생성했겠다.</p>

<p>톡톡.</p>

<p>내용만 넣으면 되네?</p>

<p>짝!</p>

<p><code class="language-plaintext highlighter-rouge">src/users</code> 안의 구조를 다음과 같이 해주세요!!
spec 파일들은 지금 없어도 됩니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>users
│  users.repository.ts
│  users.controller.spec.ts
│  users.controller.ts
│  users.entity.ts
│  users.module.ts
│  users.service.spec.ts
│  users.service.ts
│
└─dto
        create-user.dto.ts
        index.ts
        update-user.dto.ts
</code></pre></div></div>

<p>우리는 User 의 요구사항 맞게 적절히 Entity 를 설계해야 합니다. 왜냐면 이 안에 있는 내용이 데이터베이스 테이블 스키마로 적용될 녀석들이거든요!!</p>

<p><a href="https://github.com/Tocktock/nest-practice">요구사항보기</a></p>

<p>바로 모든 요구사항을 만족시키기는 복잡하니 할 수 있는거 먼저 채워 나갑시다!!</p>

<p><code class="language-plaintext highlighter-rouge">users.entity.ts</code> 안을 다음과 같이 채워주세요!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BeforeInsert</span><span class="p">,</span> <span class="nx">Column</span><span class="p">,</span> <span class="nx">Entity</span><span class="p">,</span> <span class="nx">PrimaryGeneratedColumn</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">typeorm</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">argon2</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">argon2</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">(</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UserEntity</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">length</span><span class="p">:</span> <span class="mi">32</span> <span class="p">})</span>
  <span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">hashPassword</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">argon2</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">default</span><span class="p">:</span> <span class="dl">""</span> <span class="p">})</span>
  <span class="nx">imageLink</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@Entity</code> : 이 annotation 이 있으면 nestjs가 보고 있다가 DB 스키마 적용을 위해 참고하게 됩니다!! 이후 repository 클래스에서도 참고할 수 있는 클래스가 됩니다. 괄호안에 넣은 내용이 테이블의 이름이 됩니다.</li>
  <li><code class="language-plaintext highlighter-rouge">PrimaryGeneratedColumn</code> : 이 annotion이 있다면 이 테이블은 해당 필드가 primary key 가 됩니다. 괄호 안에 아무런 내용을 넣지 않으면 id 는 auto increment 가 적용됩니다.
    <blockquote>
      <p><a href="https://velog.io/@qnfmtm666/series/DevTip">uuid vs auto increment</a></p>
    </blockquote>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Column</code> : 이 annotion 이 있으면 테이블의 필드로 만들어지게 됩니다. 괄호 안에 여러 옵션을 넣을 수 있습니다. <a href="https://typeorm.io/#/entities/column-options">모든 괄호 안의 옵션 보기</a></li>
  <li><code class="language-plaintext highlighter-rouge">BeforeInsert</code> : 요 녀석은 데이터베이스에 insert 하기 전에 수행되는 녀석입니다. 비밀번호를 복호화 할 수 없게 hash 함수를 이용해 저장합시다.</li>
</ul>

<p>아참 해쉬 함수를 쓰기 위해 argon2 를 설치해야 합니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>argon2 <span class="nt">--save</span>
</code></pre></div></div>

<h2 id="-repository-와-dto-변경하기">🔨 Repository 와 Dto 변경하기!</h2>

<h3 id="repository">Repository</h3>

<p><code class="language-plaintext highlighter-rouge">Repository</code> 는 우리가 만든 Entity 를 관리(insert, update, delete, load, etc.)해줄 녀석이라고 보시면 됩니다.</p>

<p><code class="language-plaintext highlighter-rouge">users.repository.ts</code> 안의 내용을 다음과 같이 채워주세요!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">EntityRepository</span><span class="p">,</span> <span class="nx">Repository</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">typeorm</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">UserEntity</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./users.entity</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">UserEntity</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UserRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">UserEntity</span><span class="o">&gt;</span> <span class="p">{}</span>
</code></pre></div></div>

<p>엥? 이것만 해도 되는건가??</p>

<ul>
  <li>네!!</li>
</ul>

<p>이렇게 Repository 를 만들어주시면 UserEntity에 대해 기본적인 쿼리를 그냥 쓸 수 있습니다.
복잡한 쿼리는 여기서 만들어주셔도 되고 이후 나올 query builder 로 해당 클래스에서 쓰셔도 됩니다!</p>

<h3 id="dto">DTO</h3>

<p><strong>DTO</strong>(Data Transfer Object) 는 데이터가 어떤 구조로 전송되는지에 대한 정보를 담고 있는 클래스 입니다.</p>

<p>dto 폴더 안에
<code class="language-plaintext highlighter-rouge">create-user.dto.ts</code> 폴더에 다음과 같이 작성해주세요</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">IsNotEmpty</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">class-validator</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">CreateUserDto</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">IsNotEmpty</span><span class="p">()</span>
  <span class="k">readonly</span> <span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsNotEmpty</span><span class="p">()</span>
  <span class="k">readonly</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsNotEmpty</span><span class="p">()</span>
  <span class="k">readonly</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">class-validator</code> 는 data 가 전송될 때 해당 필드가 적절한 유효성을 가지는지 검사해주는 라이브러리 입니다.</p>

<p>자 이제 Service 만 바꾸면 됩니다!!</p>

<h2 id="-user-service-변경하기">🤗 User Service 변경하기!!</h2>

<p>자 구조는 준비 되었습니다. 이제 로직만 잘 작성해주면 됩니다 화이팅!!</p>

<p>먼저 의존성 주입을 위해 UserService 생성자에 다음과 같이 적어줍시다!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="nx">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div></div>

<p>자 이것 만으로 객체가 주입됬습니드어어어!! 얼마나 좋아~!</p>

<h3 id="user-create">User create</h3>

<p><code class="language-plaintext highlighter-rouge">users.service.ts</code> 파일 내에 create 함수 안을 다음과 같이 바꿔주세요!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">createUserDto</span><span class="p">:</span> <span class="nx">CreateUserDto</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">createUserDto</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">getByUserName</span> <span class="o">=</span> <span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserEntity</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">user.username = :username</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">byUserName</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getByUserName</span><span class="p">.</span><span class="nx">getOne</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">byUserName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">{</span> <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UserName is already exists</span><span class="dl">'</span> <span class="p">};</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Input data validation falied</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span> <span class="p">},</span>
        <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">BAD_REQUEST</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">getByEmail</span> <span class="o">=</span> <span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserEntity</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">user.email = :email</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">byEmail</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getByEmail</span><span class="p">.</span><span class="nx">getOne</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">byEmail</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="dl">'</span><span class="s1">email is already exists</span><span class="dl">'</span> <span class="p">};</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Input data validation falied</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span> <span class="p">},</span>
        <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">BAD_REQUEST</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// const thisUser = this.userRepository.findOne({ username: username });</span>
    <span class="c1">// const thisEmail = this.userRepository.findOne({ email: email });</span>

    <span class="c1">// create new user</span>
    <span class="kd">let</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserEntity</span><span class="p">();</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">email</span><span class="p">;</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">username</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">validate_error</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">validate_error</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">_error</span> <span class="o">=</span> <span class="p">{</span> <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UserInput is not valid check type</span><span class="dl">'</span> <span class="p">};</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Input data validation failed</span><span class="dl">'</span><span class="p">,</span> <span class="nx">_error</span> <span class="p">},</span>
        <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">BAD_REQUEST</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>먼저 username 과 email 은 유일해야 하기 때문에 이를 검사해보죠!!</p>

<p>먼저 살펴볼 것은 <code class="language-plaintext highlighter-rouge">createQueryBuilder</code> 입니다.
typeorm 은 <code class="language-plaintext highlighter-rouge">createQueryBuilder</code> 라는 함수를 통해 코드 안에서 SQL 문을 작성할 수 있게 해줍니다.
이 코드로 인해 작성된 sql 문은 바로 실행되는 것이 아니라 실질적으로 DB 와 데이터 교환이 일어나면 실행 됩니다.</p>

<p>맨 처음 만든 SQL 문은</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">byEmail</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getByEmail</span><span class="p">.</span><span class="nx">getOne</span><span class="p">();</span>
</code></pre></div></div>

<p>여기서 수행 됩니다. DB 의 쿼리 속도와 우리가 만든 백엔드 서버에서 코드를 실행하는 속도 차이가 많이 나기 때문에 비동기 식으로 수행했습니다.</p>

<p>마찬가지로 username 도 검사해줍시다!!</p>

<p>사실 이 기능은 createQueryBuilder 를 안써도 됩니다. Repository 를 작성했으므로 기본적인 기능은 이미 지원이 되기 때문입니다.
예들 들어 username 을 기준으로 가져오고 싶다면 다음과 같이 적으면 됩니다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">});</span>
</code></pre></div></div>

<p>이해를 돕고자 <code class="language-plaintext highlighter-rouge">createQueryBuilder</code> 를 사용했습니다</p>

<p>마찬가지로 findByEmail 함수를 다음과 같이 사용하시면</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">async</span> <span class="nx">findByEmail</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>email 기준으로 유저를 찾을 수 있습니다!!</p>

<h2 id="-module-에-import-해주기">🔨 Module 에 import 해주기!!</h2>

<p>자 거의 다 왔습니다!!</p>

<p><code class="language-plaintext highlighter-rouge">users.module.ts</code> 파일 안에 imports 부분에 다음과 같이 모듈을 import 해줍시다!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span><span class="nx">TypeOrmModule</span><span class="p">.</span><span class="nx">forFeature</span><span class="p">([</span><span class="nx">UserRepository</span><span class="p">])],</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersService</span><span class="p">],</span>
  <span class="na">exports</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersService</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersModule</span> <span class="p">{}</span>
</code></pre></div></div>

<h2 id="-이제-실행된다">😃 이제 실행된다!!</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run start
</code></pre></div></div>

<p>위 명령어를 통해 어플리케이션을 실행을 합시다.
오류가 없다면 다음과 같이 로그가 뜹니다!!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [NestFactory] Starting Nest application...
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] TypeOrmModule dependencies initialized +97ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] AppModule dependencies initialized +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] TypeOrmCoreModule dependencies initialized +213ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] TypeOrmModule dependencies initialized +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] UsersModule dependencies initialized +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RoutesResolver] AppController {}: +14ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {, GET} route +18ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RoutesResolver] UsersController {/users}: +10ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users, POST} route +7ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users, GET} route +3ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users/:email, GET} route +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users/:id, PUT} route +11ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users/:id, DELETE} route +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [NestApplication] Nest application successfully started +2ms
</code></pre></div></div>

<p>우후 우후~ 우후~ 우후~ 성공!!
고생하셨습니다.</p>

<h2 id="-아직-테스트가-남았다">🤣 아직 테스트가 남았다!!!</h2>

<p>저는 Rest Client 라는 vscode extension 을 이용하여 테스트를 진행했습니다. postman, curl 여러분이 편하신 툴을 이용해주세요!!</p>

<p>자 다음과 같이 요청을 하면!</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="nf">POST</span> <span class="nn">http://localhost:3000/users</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="s">    Content-Type: application/json</span>

    {
        "username": "manynang",
        "email" : "nono@cat.co.kr",
        "password" : "manyang"
    }
</code></pre></div></div>

<p>다음과 같이 데이터가 출력이 됩니다!!</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="s">    X-Powered-By: Express</span>
<span class="s">    Content-Type: application/json; charset=utf-8</span>
<span class="s">    Content-Length: 179</span>
<span class="s">    ETag: W/"b3-G/i5vHuN9KZDYAV9wTSwyMToetE"</span>
<span class="s">    Date: Mon, 01 Feb 2021 05:41:10 GMT</span>
<span class="s">    Connection: close</span>

    {
    "email": "nono@cat.co.kr",
    "password": "$argon2i$v=19$m=4096,t=3,p=1$LthoEnjA4KlaeaE/8YhMPg$2bNUqzjlCqbomBtDTkcYzTHjibaSrjefgJDzJWTvGFQ",
    "username": "manynang",
    "id": 1,
    "imageLink": ""
    }
</code></pre></div></div>

<p>웁스 .. 비밀번호가 나오는군요… 이래서 테스트가 중요한겁니다.</p>

<p>저희는 유저 id만 가져오도록 하겠습니다.
UserCreate save 하는 부분을</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</code></pre></div></div>

<p>이와 같이 바꿔줍시다.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="s">    X-Powered-By: Express</span>
<span class="s">    Content-Type: text/html; charset=utf-8</span>
<span class="s">    Content-Length: 1</span>
<span class="s">    ETag: W/"1-NWoZK3kTsExUV00Ywo1G5jlUKKs"</span>
<span class="s">    Date: Mon, 01 Feb 2021 05:50:44 GMT</span>
<span class="s">    Connection: close</span>

    1
</code></pre></div></div>

<p>자 성공!</p>

<p>자 다시 위에 POST 관련 문을 다시 보내면?</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">400</span> <span class="ne">Bad Request</span>
<span class="s">    X-Powered-By: Express</span>
<span class="s">    Content-Type: application/json; charset=utf-8</span>
<span class="s">    Content-Length: 92</span>
<span class="s">    ETag: W/"5c-j/u2GjtMeXEpPJw+5WWgYELKwpM"</span>
<span class="s">    Date: Mon, 01 Feb 2021 05:54:56 GMT</span>
<span class="s">    Connection: close</span>

    {
    "message": "Input data validation falied",
    "error": {
        "username": "UserName is already exists"
    }
    }
</code></pre></div></div>

<p>성공~~!!!!
중복된 username 을 걸렀습니다 ㅜㅜ!!</p>

<hr />

<p>고생했습니다 ㅜㅜ!!!!</p>

<p>다음에는 위 코드를 Refactor 하는 과정으로 찾아뵙도록 하겠습니다!!
오늘도 즐거운 하루 보내세요!!</p>

<p>피드백은 항상 환영입니다.</p>

    <hr />
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://tocktock.github.io/algorithms/algorithms-leetcode-45/"> leetcode Jump Game II 문제풀기 </a>
    </h1>

    <span class="post-date">30 Jan 2021</span>

    <p>#[leetcode][45] Jump Game II 문제풀기!</p>

<hr />

<ul>
  <li><a href="https://leetcode.com/problems/jump-game-ii">문제풀러가기✈</a></li>
</ul>

<hr />

<h2 id="-문제-요약">👓 문제 요약</h2>

<p>처음 인덱스에서 마지막 인덱스에 도달하려면 몇 번 점프해야할까?
해당 인덱스에서 최대 얼마나 뛸 수 있는지는 알려줄게!</p>

<blockquote>
  <p>자세한 문제 설명과 릿코드 홈페이지 참고. <a href="https://leetcode.com/problems/jump-game-ii">문제풀러가기</a></p>
</blockquote>

<h2 id="-문제-풀이">🔑 문제 풀이</h2>

<p>주어지는 인풋의 길이가 최대 30,000 이기 때문에 최소 O(nlgn) 기법을 써야 합니다!</p>

<p>저는 탐욕 기법으로 해당 인덱스에서 뛰었을 때 최대로 가는 놈만 골라서 그냥 뛰었습니다!</p>

<h2 id="-소스코드-및-소스해석">🥽 소스코드 및 소스해석</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">jump</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">nums</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">nowPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">maxNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">dist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">dist</span> <span class="o">&lt;=</span> <span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">dist</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">maxNum</span> <span class="o">&lt;=</span> <span class="nx">dist</span> <span class="o">+</span> <span class="nx">nums</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">dist</span><span class="p">]</span> <span class="o">||</span> <span class="nx">dist</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">maxNum</span> <span class="o">=</span> <span class="nx">dist</span> <span class="o">+</span> <span class="nx">nums</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">dist</span><span class="p">];</span>
        <span class="nx">nowPos</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">dist</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">nowPos</span><span class="p">;</span>
    <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nowPos</span> <span class="o">&gt;=</span> <span class="nx">nums</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="-문제-후기">🔨 문제 후기</h2>

<p>왜 hard 난이도 인지 알 수 없는 문제!! 끄앗!!!</p>

    <hr />
  </div>
  
</div>

<div class="pagination">
  
  <a
    class="pagination-item older"
    href="https://tocktock.github.io/page2"
    >Older</a
  >
   
  <span class="pagination-item newer">Newer</span>
  
</div>
</div>
  
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src="/public/js/script.js"></script>
  </body>
</html>
