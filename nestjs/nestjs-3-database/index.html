<!DOCTYPE html>
<html lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1"
  />

  <title>
     NestJS 블로그 만들기 - 데이터베이스 연결 &middot; 영원 
  </title>

  
  <link rel="canonical" href="https://tocktock.github.io/nestjs/nestjs-3-database/" />
  

  <link rel="stylesheet" href="https://tocktock.github.io/public/css/poole.css" />
  <link rel="stylesheet" href="https://tocktock.github.io/public/css/syntax.css" />
  <link rel="stylesheet" href="https://tocktock.github.io/public/css/lanyon.css" />

  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400"
  />

  <link
    rel="apple-touch-icon-precomposed"
    sizes="144x144"
    href="https://tocktock.github.io/public/apple-touch-icon-precomposed.png"
  />
  <link rel="shortcut icon" href="https://tocktock.github.io/public/favicon.ico" />

  <link
    rel="alternate"
    type="application/rss+xml"
    title="RSS"
    href="https://tocktock.github.io/atom.xml"
  />

  <!-- <script>
    (function (i, s, o, g, r, a, m) {
      i["GoogleAnalyticsObject"] = r;
      (i[r] =
        i[r] ||
        function () {
          (i[r].q = i[r].q || []).push(arguments);
        }),
        (i[r].l = 1 * new Date());
      (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m);
    })(
      window,
      document,
      "script",
      "//www.google-analytics.com/analytics.js",
      "ga"
    );
    ga("create", "UA-178749172-1", "auto");
    ga("send", "pageview");
  </script> -->
</head>


  <body>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" />

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item description">
    <p>Developer with Cat</p>
  </div>

  <nav class="sidebar-nav">
    <a
      class="sidebar-nav-item"
      href="https://tocktock.github.io/"
      >Home</a
    >
                
    <div>
      <a
        class="sidebar-nav-item"
        href="https://tocktock.github.io/about/"
        >About me</a
      >
               
    <div>
      <a
        class="sidebar-nav-item"
        href="https://tocktock.github.io/categories/"
        >Categories</a
      >
      
      <ul class="sidebar-categories">
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/Algorithms"
            >Algorithms (28)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/Jekyll"
            >Jekyll (1)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/elasticsearch"
            >elasticsearch (9)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/NestJS"
            >NestJS (3)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/DevTip"
            >DevTip (1)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/nodejs"
            >nodejs (1)</a
          >
        </li>
        
      </ul>
                                                                   
    </div>

    <a class="sidebar-nav-item" href="https://github.com/Tocktock/tocktock.github.io">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2021. All rights reserved.</p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">영원</a>
            <small>웹 개발과 일상</small>
          </h3>
        </div>
      </div>

      <div class="container content"><div class="post">
  <h1 class="post-title">NestJS 블로그 만들기 - 데이터베이스 연결</h1>
  <span class="post-date">01 Feb 2021</span>
  <h1 id="2-nestjs-블로그-만들기---데이터베이스-연결-postgresql과-user-모듈">2. NestJS 블로그 만들기 - 데이터베이스 연결 (Postgresql)과 User 모듈</h1>

<hr />

<blockquote>
  <p>저는 오늘 포스팅할 분량의 앱을 만든 후 블로그 포스팅하기 때문에 중간에 오류가 생길 수도 있습니다.
오류 내용과 함께 댓글을 달아주시면 저도 알아보겠습니다!!</p>
</blockquote>

<h2 id="-데이터-베이스-연결하기-">👌 데이터 베이스 연결하기 !!</h2>

<h3 id="postgresql-설치">PostgreSQL 설치!!</h3>

<p>여러분 드디어 데이터베이스에 연결할 시간이 왔습니다!!.
실제 연습할 때는 배열 같은 임의 적인 놈을 만들고 나서 하긴하지만… 바로 연결해보죠!</p>

<p>저희는 Postgresql 을 사용할 겁니다!! 다른 데이터베이스를 사용하셔도 됩니다!!</p>

<blockquote>
  <p>Postgresql 은 오픈소스 데이터베이스로 SQL 표준을 잘 지원합니다. 일단 무료입니다!!
설치하는 방법은 정식 문서나 타 블로그 포스트를 참조해주세요. <a href="https://junlab.tistory.com/177">postgresql 설치방법</a></p>
</blockquote>

<p>편의를 위해 pgAdmin 툴을 이용하여 postgresql 을 제어하겠습니다.!!</p>

<p>기존의 서버 (PostgreSQL 13 이군요 저는) 를 우클릭하여 데이터베이스를 만듭시다!!
저는 데이터베이스 이름을 <code class="language-plaintext highlighter-rouge">nest_blog</code> 라고 했습니다!!</p>

<blockquote>
  <p>원하시는 서버를 만들고 데이터베이스를 생성하셔도 괜찮습니다.</p>
</blockquote>

<p>데이터베이스의 스키마 구조에 대해서는 아직 정의하지 않겠습니다. NestJS가 해줄거거든요!!</p>

<h3 id="typeorm-">TypeORM !!</h3>

<p>TypeORM 은 NodeJS 환경에서 사용할 수 있는 ORM (Object Relational Mapping) 라이브러리 입니다!!</p>

<blockquote>
  <p>ORM 은 간단히 말해 Object 를 Database 스키마에 적절하게 적용시키게 해주는 기능이라 생각하면 편합니다.!!</p>
</blockquote>

<p>설치 설치~ nestjs 루트 폴더에서 다음 명령어로 설치해주세요 !!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nv">$ </span>npm <span class="nb">install </span>typeorm @nestjs/typeorm <span class="nt">--save</span>
</code></pre></div></div>

<p>설치가 됬으면 <code class="language-plaintext highlighter-rouge">ormconfig.json</code> 이라는 파일을 루트 폴더에 만들어 줍니다.
나중에 TypeORM 모듈이 이 파일을 참고해 데이터베이스에 연결을 시도합니다!!</p>

<p>다음과 같이 입력해주세요!!</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">5432</span><span class="p">,</span><span class="w">
  </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="err">여러분이</span><span class="w"> </span><span class="err">설정했던</span><span class="w"> </span><span class="err">비밀번호!</span><span class="p">,</span><span class="w">
  </span><span class="nl">"database"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nest_blog"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"entities"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"dist/**/**.entity{.ts,.js}"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"synchronize"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">type</code> : 우리가 사용하게 될 데이터베이스 시스템을 나타냅니다.</li>
  <li><code class="language-plaintext highlighter-rouge">host</code> : db 연결 주소입니다. 기본적으로 <code class="language-plaintext highlighter-rouge">localhost</code> 를 이용하고 db 를 다른 머신에서 실행한다면 그 머신에 접속하기 위한 주소로 변경해주시면 됩니다.</li>
  <li><code class="language-plaintext highlighter-rouge">port</code> : db 연결 포트 입니다. 기본은 <code class="language-plaintext highlighter-rouge">5432</code> 입니다.</li>
  <li><code class="language-plaintext highlighter-rouge">username</code> : 별 다른 설정을 안했다면 <code class="language-plaintext highlighter-rouge">postgres</code> 입니다</li>
  <li><code class="language-plaintext highlighter-rouge">password</code> : 설치 과정에서 설정했던 비밀번호를 입력하세요.</li>
  <li><code class="language-plaintext highlighter-rouge">database</code> : 위에서 만들었던 데이터베이스의 이름을 입력하시면 됩니다. 저는 <code class="language-plaintext highlighter-rouge">nest_blog</code> 라고 했습니다.</li>
  <li><code class="language-plaintext highlighter-rouge">entities</code> : 반드시 <code class="language-plaintext highlighter-rouge">dist</code> 아래의 폴더로 지정해주세요. 안그러면 오류날 수도 있습니다. 이 설정의 경로에 있는 파일을 참고하여 DB 에서 스키마를 설정하게 됩니다.</li>
  <li><code class="language-plaintext highlighter-rouge">synchronize</code> : 이 설정을 true 로 하시면 앱 작동시 DB 스키마가 자동으로 생성되게 됩니다.</li>
</ul>

<blockquote>
  <p>자세한 내용은 <a href="https://typeorm.io/#/using-ormconfig">ormconfig 탐방하기!!</a> 을 참조해주세요~</p>
</blockquote>

<h3 id="app-모듈에서-import--그리고-실행">app 모듈에서 import !! 그리고 실행!!</h3>

<p>자 이제 <code class="language-plaintext highlighter-rouge">app.moudle.ts</code> 파일로 가서 TypeOrmMoudle 을 import 해줍시다!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersModule</span><span class="p">,</span> <span class="nx">TypeOrmModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">()],</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppService</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ormconfig.json</code> 파일을 생성하지 않았다면, forRoot 함수 안에 설정 내용을 적으셔야 합니다.!!
파일로 관리하는게 더 편하겠죠~?</p>

<p>자 이제 루트 폴더에서 다음과 같은 명령어를 수행해봅시다!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run start
</code></pre></div></div>

<p>별 다른 오류가 없다면 정상적으로 연결 된겁니다!! 우라하!!!
저희는 아직 Entity에 대해서 설정을 하지 않았기 때문에 테이블에 별 내용은 없습니다.</p>

<p>이후에 Entity 를 만든 후에는 DB 에서 테이블을 삭제하고 다시 연결해주시면 만든 내용이 적용됩니다!</p>

<h2 id="-user-entity-만들기">🛴 User Entity 만들기.</h2>

<p>톡.</p>

<p>DB 도 연결했겠다.</p>

<p>톡톡.</p>

<p>User Entity Template 도 생성했겠다.</p>

<p>톡톡.</p>

<p>내용만 넣으면 되네?</p>

<p>짝!</p>

<p><code class="language-plaintext highlighter-rouge">src/users</code> 안의 구조를 다음과 같이 해주세요!!
spec 파일들은 지금 없어도 됩니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>users
│  users.repository.ts
│  users.controller.spec.ts
│  users.controller.ts
│  users.entity.ts
│  users.module.ts
│  users.service.spec.ts
│  users.service.ts
│
└─dto
        create-user.dto.ts
        index.ts
        update-user.dto.ts
</code></pre></div></div>

<p>우리는 User 의 요구사항 맞게 적절히 Entity 를 설계해야 합니다. 왜냐면 이 안에 있는 내용이 데이터베이스 테이블 스키마로 적용될 녀석들이거든요!!</p>

<p><a href="https://github.com/Tocktock/nest-practice">요구사항보기</a></p>

<p>바로 모든 요구사항을 만족시키기는 복잡하니 할 수 있는거 먼저 채워 나갑시다!!</p>

<p><code class="language-plaintext highlighter-rouge">users.entity.ts</code> 안을 다음과 같이 채워주세요!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BeforeInsert</span><span class="p">,</span> <span class="nx">Column</span><span class="p">,</span> <span class="nx">Entity</span><span class="p">,</span> <span class="nx">PrimaryGeneratedColumn</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">typeorm</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">argon2</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">argon2</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">(</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UserEntity</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">length</span><span class="p">:</span> <span class="mi">32</span> <span class="p">})</span>
  <span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">hashPassword</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">argon2</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">default</span><span class="p">:</span> <span class="dl">""</span> <span class="p">})</span>
  <span class="nx">imageLink</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@Entity</code> : 이 annotation 이 있으면 nestjs가 보고 있다가 DB 스키마 적용을 위해 참고하게 됩니다!! 이후 repository 클래스에서도 참고할 수 있는 클래스가 됩니다. 괄호안에 넣은 내용이 테이블의 이름이 됩니다.</li>
  <li><code class="language-plaintext highlighter-rouge">PrimaryGeneratedColumn</code> : 이 annotion이 있다면 이 테이블은 해당 필드가 primary key 가 됩니다. 괄호 안에 아무런 내용을 넣지 않으면 id 는 auto increment 가 적용됩니다.
    <blockquote>
      <p><a href="https://velog.io/@qnfmtm666/series/DevTip">uuid vs auto increment</a></p>
    </blockquote>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Column</code> : 이 annotion 이 있으면 테이블의 필드로 만들어지게 됩니다. 괄호 안에 여러 옵션을 넣을 수 있습니다. <a href="https://typeorm.io/#/entities/column-options">모든 괄호 안의 옵션 보기</a></li>
  <li><code class="language-plaintext highlighter-rouge">BeforeInsert</code> : 요 녀석은 데이터베이스에 insert 하기 전에 수행되는 녀석입니다. 비밀번호를 복호화 할 수 없게 hash 함수를 이용해 저장합시다.</li>
</ul>

<p>아참 해쉬 함수를 쓰기 위해 argon2 를 설치해야 합니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>argon2 <span class="nt">--save</span>
</code></pre></div></div>

<h2 id="-repository-와-dto-변경하기">🔨 Repository 와 Dto 변경하기!</h2>

<h3 id="repository">Repository</h3>

<p><code class="language-plaintext highlighter-rouge">Repository</code> 는 우리가 만든 Entity 를 관리(insert, update, delete, load, etc.)해줄 녀석이라고 보시면 됩니다.</p>

<p><code class="language-plaintext highlighter-rouge">users.repository.ts</code> 안의 내용을 다음과 같이 채워주세요!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">EntityRepository</span><span class="p">,</span> <span class="nx">Repository</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">typeorm</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">UserEntity</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./users.entity</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">UserEntity</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UserRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">UserEntity</span><span class="o">&gt;</span> <span class="p">{}</span>
</code></pre></div></div>

<p>엥? 이것만 해도 되는건가??</p>

<ul>
  <li>네!!</li>
</ul>

<p>이렇게 Repository 를 만들어주시면 UserEntity에 대해 기본적인 쿼리를 그냥 쓸 수 있습니다.
복잡한 쿼리는 여기서 만들어주셔도 되고 이후 나올 query builder 로 해당 클래스에서 쓰셔도 됩니다!</p>

<h3 id="dto">DTO</h3>

<p><strong>DTO</strong>(Data Transfer Object) 는 데이터가 어떤 구조로 전송되는지에 대한 정보를 담고 있는 클래스 입니다.</p>

<p>dto 폴더 안에
<code class="language-plaintext highlighter-rouge">create-user.dto.ts</code> 폴더에 다음과 같이 작성해주세요</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">IsNotEmpty</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">class-validator</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">CreateUserDto</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">IsNotEmpty</span><span class="p">()</span>
  <span class="k">readonly</span> <span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsNotEmpty</span><span class="p">()</span>
  <span class="k">readonly</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsNotEmpty</span><span class="p">()</span>
  <span class="k">readonly</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">class-validator</code> 는 data 가 전송될 때 해당 필드가 적절한 유효성을 가지는지 검사해주는 라이브러리 입니다.</p>

<p>자 이제 Service 만 바꾸면 됩니다!!</p>

<h2 id="-user-service-변경하기">🤗 User Service 변경하기!!</h2>

<p>자 구조는 준비 되었습니다. 이제 로직만 잘 작성해주면 됩니다 화이팅!!</p>

<p>먼저 의존성 주입을 위해 UserService 생성자에 다음과 같이 적어줍시다!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="nx">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div></div>

<p>자 이것 만으로 객체가 주입됬습니드어어어!! 얼마나 좋아~!</p>

<h3 id="user-create">User create</h3>

<p><code class="language-plaintext highlighter-rouge">users.service.ts</code> 파일 내에 create 함수 안을 다음과 같이 바꿔주세요!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">createUserDto</span><span class="p">:</span> <span class="nx">CreateUserDto</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">createUserDto</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">getByUserName</span> <span class="o">=</span> <span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserEntity</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">user.username = :username</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">byUserName</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getByUserName</span><span class="p">.</span><span class="nx">getOne</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">byUserName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">{</span> <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UserName is already exists</span><span class="dl">'</span> <span class="p">};</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Input data validation falied</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span> <span class="p">},</span>
        <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">BAD_REQUEST</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">getByEmail</span> <span class="o">=</span> <span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserEntity</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">user.email = :email</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">byEmail</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getByEmail</span><span class="p">.</span><span class="nx">getOne</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">byEmail</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="dl">'</span><span class="s1">email is already exists</span><span class="dl">'</span> <span class="p">};</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Input data validation falied</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span> <span class="p">},</span>
        <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">BAD_REQUEST</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// const thisUser = this.userRepository.findOne({ username: username });</span>
    <span class="c1">// const thisEmail = this.userRepository.findOne({ email: email });</span>

    <span class="c1">// create new user</span>
    <span class="kd">let</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserEntity</span><span class="p">();</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">email</span><span class="p">;</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">username</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">validate_error</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">validate_error</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">_error</span> <span class="o">=</span> <span class="p">{</span> <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UserInput is not valid check type</span><span class="dl">'</span> <span class="p">};</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpException</span><span class="p">(</span>
        <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Input data validation failed</span><span class="dl">'</span><span class="p">,</span> <span class="nx">_error</span> <span class="p">},</span>
        <span class="nx">HttpStatus</span><span class="p">.</span><span class="nx">BAD_REQUEST</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>먼저 username 과 email 은 유일해야 하기 때문에 이를 검사해보죠!!</p>

<p>먼저 살펴볼 것은 <code class="language-plaintext highlighter-rouge">createQueryBuilder</code> 입니다.
typeorm 은 <code class="language-plaintext highlighter-rouge">createQueryBuilder</code> 라는 함수를 통해 코드 안에서 SQL 문을 작성할 수 있게 해줍니다.
이 코드로 인해 작성된 sql 문은 바로 실행되는 것이 아니라 실질적으로 DB 와 데이터 교환이 일어나면 실행 됩니다.</p>

<p>맨 처음 만든 SQL 문은</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">byEmail</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getByEmail</span><span class="p">.</span><span class="nx">getOne</span><span class="p">();</span>
</code></pre></div></div>

<p>여기서 수행 됩니다. DB 의 쿼리 속도와 우리가 만든 백엔드 서버에서 코드를 실행하는 속도 차이가 많이 나기 때문에 비동기 식으로 수행했습니다.</p>

<p>마찬가지로 username 도 검사해줍시다!!</p>

<p>사실 이 기능은 createQueryBuilder 를 안써도 됩니다. Repository 를 작성했으므로 기본적인 기능은 이미 지원이 되기 때문입니다.
예들 들어 username 을 기준으로 가져오고 싶다면 다음과 같이 적으면 됩니다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">});</span>
</code></pre></div></div>

<p>이해를 돕고자 <code class="language-plaintext highlighter-rouge">createQueryBuilder</code> 를 사용했습니다</p>

<p>마찬가지로 findByEmail 함수를 다음과 같이 사용하시면</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">async</span> <span class="nx">findByEmail</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">email</span> <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>email 기준으로 유저를 찾을 수 있습니다!!</p>

<h2 id="-module-에-import-해주기">🔨 Module 에 import 해주기!!</h2>

<p>자 거의 다 왔습니다!!</p>

<p><code class="language-plaintext highlighter-rouge">users.module.ts</code> 파일 안에 imports 부분에 다음과 같이 모듈을 import 해줍시다!!</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span><span class="nx">TypeOrmModule</span><span class="p">.</span><span class="nx">forFeature</span><span class="p">([</span><span class="nx">UserRepository</span><span class="p">])],</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersService</span><span class="p">],</span>
  <span class="na">exports</span><span class="p">:</span> <span class="p">[</span><span class="nx">UsersService</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersModule</span> <span class="p">{}</span>
</code></pre></div></div>

<h2 id="-이제-실행된다">😃 이제 실행된다!!</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm run start
</code></pre></div></div>

<p>위 명령어를 통해 어플리케이션을 실행을 합시다.
오류가 없다면 다음과 같이 로그가 뜹니다!!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [NestFactory] Starting Nest application...
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] TypeOrmModule dependencies initialized +97ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] AppModule dependencies initialized +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] TypeOrmCoreModule dependencies initialized +213ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] TypeOrmModule dependencies initialized +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [InstanceLoader] UsersModule dependencies initialized +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RoutesResolver] AppController {}: +14ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {, GET} route +18ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RoutesResolver] UsersController {/users}: +10ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users, POST} route +7ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users, GET} route +3ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users/:email, GET} route +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users/:id, PUT} route +11ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [RouterExplorer] Mapped {/users/:id, DELETE} route +1ms
[Nest] 33080   - 2021-02-01 2:36:58 ├F10: PM┤   [NestApplication] Nest application successfully started +2ms
</code></pre></div></div>

<p>우후 우후~ 우후~ 우후~ 성공!!
고생하셨습니다.</p>

<h2 id="-아직-테스트가-남았다">🤣 아직 테스트가 남았다!!!</h2>

<p>저는 Rest Client 라는 vscode extension 을 이용하여 테스트를 진행했습니다. postman, curl 여러분이 편하신 툴을 이용해주세요!!</p>

<p>자 다음과 같이 요청을 하면!</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="nf">POST</span> <span class="nn">http://localhost:3000/users</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="s">    Content-Type: application/json</span>

    {
        "username": "manynang",
        "email" : "nono@cat.co.kr",
        "password" : "manyang"
    }
</code></pre></div></div>

<p>다음과 같이 데이터가 출력이 됩니다!!</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="s">    X-Powered-By: Express</span>
<span class="s">    Content-Type: application/json; charset=utf-8</span>
<span class="s">    Content-Length: 179</span>
<span class="s">    ETag: W/"b3-G/i5vHuN9KZDYAV9wTSwyMToetE"</span>
<span class="s">    Date: Mon, 01 Feb 2021 05:41:10 GMT</span>
<span class="s">    Connection: close</span>

    {
    "email": "nono@cat.co.kr",
    "password": "$argon2i$v=19$m=4096,t=3,p=1$LthoEnjA4KlaeaE/8YhMPg$2bNUqzjlCqbomBtDTkcYzTHjibaSrjefgJDzJWTvGFQ",
    "username": "manynang",
    "id": 1,
    "imageLink": ""
    }
</code></pre></div></div>

<p>웁스 .. 비밀번호가 나오는군요… 이래서 테스트가 중요한겁니다.</p>

<p>저희는 유저 id만 가져오도록 하겠습니다.
UserCreate save 하는 부분을</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</code></pre></div></div>

<p>이와 같이 바꿔줍시다.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="s">    X-Powered-By: Express</span>
<span class="s">    Content-Type: text/html; charset=utf-8</span>
<span class="s">    Content-Length: 1</span>
<span class="s">    ETag: W/"1-NWoZK3kTsExUV00Ywo1G5jlUKKs"</span>
<span class="s">    Date: Mon, 01 Feb 2021 05:50:44 GMT</span>
<span class="s">    Connection: close</span>

    1
</code></pre></div></div>

<p>자 성공!</p>

<p>자 다시 위에 POST 관련 문을 다시 보내면?</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">    </span><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">400</span> <span class="ne">Bad Request</span>
<span class="s">    X-Powered-By: Express</span>
<span class="s">    Content-Type: application/json; charset=utf-8</span>
<span class="s">    Content-Length: 92</span>
<span class="s">    ETag: W/"5c-j/u2GjtMeXEpPJw+5WWgYELKwpM"</span>
<span class="s">    Date: Mon, 01 Feb 2021 05:54:56 GMT</span>
<span class="s">    Connection: close</span>

    {
    "message": "Input data validation falied",
    "error": {
        "username": "UserName is already exists"
    }
    }
</code></pre></div></div>

<p>성공~~!!!!
중복된 username 을 걸렀습니다 ㅜㅜ!!</p>

<hr />

<p>고생했습니다 ㅜㅜ!!!!</p>

<p>다음에는 위 코드를 Refactor 하는 과정으로 찾아뵙도록 하겠습니다!!
오늘도 즐거운 하루 보내세요!!</p>

<p>피드백은 항상 환영입니다.</p>

  <hr />
</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/nodejs/nodejs-1-what-is-nodejs/">
          Node.js 의 특징과 한계
          <small>01 Feb 2021</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/algorithms/algorithms-leetcode-45/">
          leetcode Jump Game II 문제풀기
          <small>30 Jan 2021</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/algorithms/algorithms-leetcode-44/">
          leetcode Wildcard Matching 문제풀기
          <small>30 Jan 2021</small>
        </a>
      </h3>
    </li>
    
  </ul>
</div>

</div>
  
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src="/public/js/script.js"></script>
  </body>
</html>
