<!DOCTYPE html>
<html lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1"
  />

  <title>
     Elasticsearch search query 집중탐구 - 1 &middot; 영원 
  </title>

  
  <link rel="canonical" href="https://tocktock.github.io/elasticsearch/elasticsearch-search-query/" />
  

  <link rel="stylesheet" href="https://tocktock.github.io/public/css/poole.css" />
  <link rel="stylesheet" href="https://tocktock.github.io/public/css/syntax.css" />
  <link rel="stylesheet" href="https://tocktock.github.io/public/css/lanyon.css" />

  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400"
  />

  <link
    rel="apple-touch-icon-precomposed"
    sizes="144x144"
    href="https://tocktock.github.io/public/apple-touch-icon-precomposed.png"
  />
  <link rel="shortcut icon" href="https://tocktock.github.io/public/favicon.ico" />

  <link
    rel="alternate"
    type="application/rss+xml"
    title="RSS"
    href="https://tocktock.github.io/atom.xml"
  />

  <!-- <script>
    (function (i, s, o, g, r, a, m) {
      i["GoogleAnalyticsObject"] = r;
      (i[r] =
        i[r] ||
        function () {
          (i[r].q = i[r].q || []).push(arguments);
        }),
        (i[r].l = 1 * new Date());
      (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m);
    })(
      window,
      document,
      "script",
      "//www.google-analytics.com/analytics.js",
      "ga"
    );
    ga("create", "UA-178749172-1", "auto");
    ga("send", "pageview");
  </script> -->
</head>


  <body>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox" />

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item description">
    <p>Developer with Cat</p>
  </div>

  <nav class="sidebar-nav">
    <a
      class="sidebar-nav-item"
      href="https://tocktock.github.io/"
      >Home</a
    >
                
    <div>
      <a
        class="sidebar-nav-item"
        href="https://tocktock.github.io/about/"
        >About me</a
      >
               
    <div>
      <a
        class="sidebar-nav-item"
        href="https://tocktock.github.io/categories/"
        >Categories</a
      >
      
      <ul class="sidebar-categories">
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/Algorithms"
            >Algorithms (28)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/Jekyll"
            >Jekyll (1)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/elasticsearch"
            >elasticsearch (9)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/NestJS"
            >NestJS (4)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/DevTip"
            >DevTip (1)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/nodejs"
            >nodejs (1)</a
          >
        </li>
         
        <li class="sidebar-categories-item">
          <a href="https://tocktock.github.io/categories/redux"
            >redux (1)</a
          >
        </li>
        
      </ul>
                                                                       
    </div>

    <a class="sidebar-nav-item" href="https://github.com/Tocktock/tocktock.github.io">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2021. All rights reserved.</p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">영원</a>
            <small>웹 개발과 일상</small>
          </h3>
        </div>
      </div>

      <div class="container content"><div class="post">
  <h1 class="post-title">Elasticsearch search query 집중탐구 - 1</h1>
  <span class="post-date">26 Jan 2021</span>
  <p>#[🌎elasticsearch] search query 집중탐구 - 1 전처리 과정</p>

<hr />

<ul>
  <li>
    <p><a href="https://esbook.kimjmin.net/">Elasticsearch 가이드북 ✈</a></p>
  </li>
  <li>
    <p><a href="https://www.elastic.co/kr/what-is/elasticsearch">Elasticsearch 홈페이지 가기 ✈</a></p>
  </li>
</ul>

<hr />

<h2 id="-elasitcsearch-full-text-search-의-원리">🧡 ElasitcSearch Full-Text-Search 의 원리</h2>

<h3 id="inverted-index">🙂Inverted Index</h3>

<p>Elasticsearch 는 “text” 로 매핑된 필드의 경우 그 안에 데이터를 Inverted Index 라는 구조로 저장합니다.</p>

<p>직역하자면 역 색인, 반대 색인 이런 뜻인데 대충 감이 오시나요??</p>

<p>예들 들어보겠습니다.
아래와 같은 데이터가 있다고 합시다.</p>

<table>
  <thead>
    <tr>
      <th>Id</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>“Cat is Cute”</td>
    </tr>
    <tr>
      <td>2</td>
      <td>“Dog is Cute Too”</td>
    </tr>
    <tr>
      <td>3</td>
      <td>“Cat is lazy”</td>
    </tr>
    <tr>
      <td>4</td>
      <td>“Dog is super athletic”</td>
    </tr>
  </tbody>
</table>

<p>일반적인 DBMS 에서는 <strong>“athletic”</strong> 을 검색하고 싶다하면 1번 ,2번, 3번, 4번 순서로 검색해서
<strong>“athleti”</strong> 이 있구나 Id 4를 보여줘야지. 라고 할 겁니다.</p>

<p>Inverted Index 는 조금 다릅니다.
토큰마다 값을 가지는데, 이 값은 “이 문서에 이 토큰 값이 포함되어 있어.”를 저장합니다.
위의 테이블을 아래와 같은 식으로 저장합니다.</p>

<table>
  <thead>
    <tr>
      <th>Token</th>
      <th>Id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>“cat”</td>
      <td>1, 3</td>
    </tr>
    <tr>
      <td>“dog”</td>
      <td>2, 4</td>
    </tr>
    <tr>
      <td>“cute”</td>
      <td>1, 2</td>
    </tr>
    <tr>
      <td>“lazy”</td>
      <td>3</td>
    </tr>
    <tr>
      <td>“athletic”</td>
      <td>4</td>
    </tr>
    <tr>
      <td>“super”</td>
      <td>4</td>
    </tr>
  </tbody>
</table>

<p>이 같은 경우 “athletic” 토큰이 포함된 4번 문서만 보면 됩니다. 다만 토큰을 빨리 찾기 위해 저장하는 자료구조는 좀 복잡해질겁니다.
괜찮습니다. <strong>Elasticsearch 가 대신해줄거거든요!!</strong></p>

<p>🛑🛑 단 이렇게 저장되는 건 오직 필드가 <strong>text</strong> 타입일 때만 적용됩니다.
다른말로 하자면 text 필드가 아니면 전문검색 기능을 쓸 수 없습니다!!</p>

<h3 id="analizer">🙂Analizer</h3>

<p>위의 예시에서 눈치채신 분도 계시겠지만, 처음 테이블의 내용을 Inverted Index 방법으로 저장할 때 전부 소문자로 바뀌어서 저장이 되었습니다.
그리고 저장되지 않은 단어들도 있군요. 이 과정을 <strong>Text Analysis</strong> 라고 합니다.
이 과정을 거치지 않고 진행하게 되면 검색에 필요 없는단어 가령 “is”, “too” 까지 저장해야합니다.</p>

<p>우리가 “dOG” 라고 검색해도 “Dog” 가 포함된 문서를 보고 싶다면 토큰화하는 과정에 전처리 과정을 수행해야합니다.</p>

<h4 id="1-character-filter">1. Character Filter</h4>

<p><strong>Character Filter</strong> 는 전처리과정에서 가장 먼저 수행되는 과정입니다.
<strong>Character Filter</strong> 에는 <strong>HTML Strip, Mapping, Pattern Replace</strong> 세 가지가 존재합니다.</p>

<ul>
  <li><strong>HTML Strip</strong> : 문장에 HTML 태그들을 없애주는 Filter 입니다. 예를들면,
<code class="language-plaintext highlighter-rouge">&lt;p&gt;I&amp;apos;m so &lt;b&gt;happy&lt;/b&gt;!&lt;/p&gt;</code> 라는 문장을 <code class="language-plaintext highlighter-rouge">I'm so happy!</code> 로 바꿔줍니다.</li>
  <li><strong>Mapping</strong> : 특정 문자열을 내가 원하는 값으로 대체할 수 있습니다.</li>
  <li><strong>Pattern Replace</strong> : 특정 정규식 패턴을 내가 원하는 값으로 대체할 수 있습니다.</li>
</ul>

<h4 id="2-tokenizer-filter">2. Tokenizer Filter</h4>

<p><strong>Tokenizer Filter</strong> 는 문자열을 받아 단어들을 토큰화하는 과정입니다.
Tokenizer Filter 는 많은 종류가 있는데 대표적인 3가지를 먼저 알아보겠습니다.</p>

<ul>
  <li><strong>Standard</strong> : 토큰화 할 때 <strong>공백과 hyphen(-)을</strong> 기준으로 토큰화를 수행하며, 일부 특수문자를 제거합니다.</li>
  <li><strong>Letter</strong> : 토큰화 할 때 <strong>문자열 이외</strong>를 기준으로 토큰화를 수행합니다.
예들 들어 <code class="language-plaintext highlighter-rouge">Brown-Foxes dog's</code> 같은 문자열은 [Brown, Foxes, dog, s] 로 토큰화를 수행합니다.</li>
  <li><strong>Whitespace</strong> : <strong>공백</strong> 을 기준으로 토큰화를 수행합니다. 공백, 줄바꿈, 탭 모든 공백을 포함합니다.</li>
</ul>

<blockquote>
  <p>Email, URL, Path 와 특수 목적용 Tokenizer 들이 많으니 자세한 정보는 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html">Tokenizer Document</a> 를 참조해주시와요.!!</p>
</blockquote>

<h4 id="3-token-filter">3. Token Filter</h4>

<p><strong>Token Filter</strong> 는 각 Tokenizer Filter 에 의해 만들어진 Token 들에 대한 후처리 작업을 수행합니다.
가장 대표적인 Lowercase Token Filterr 로 Stop Token Filterr 가 있습니다.</p>

<ul>
  <li><strong>Lowercase</strong> : 말 그대로 토큰들을 소문자로 <strong>바꾸는</strong> Token filter 입니다.</li>
  <li><strong>Stop</strong> : Search 기능에 필요 없는 단어들 예를 들면 is, be, to, a, as 등을 없애는 필터입니다.</li>
</ul>

<blockquote>
  <p>더 많은 Token filter 를 보고 싶으면 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/analysis-tokenfilters.html">Token Filters</a> 를 참조해주세요!! 오른쪽 메뉴바에 다양한 Token filters 가 있습니다.</p>
</blockquote>

<h4 id="4-stemming">4. Stemming</h4>

<p>또한 각 토큰들은 그 원형을 유지할 필요가 있습니다. 예를 들면 <code class="language-plaintext highlighter-rouge">working</code> 에서 <code class="language-plaintext highlighter-rouge">ing</code> 는 필요 없는 부분이며 우리는 work 만 검색하면 됩니다.
이러한 과정을 Stemming 이라고 합니다.</p>

<h4 id="etc">ETC</h4>

<p>우리가 문서에 영어만 쓰는 것은 아닙니다. 대부분 그 나라에서는 그 나라 언어를 많이 쓸 것입니다.
ElasticSearch 에 내장된 언어분석기가 없다면, Full-Text-Search 에 난항을 겪을지도 모릅니다.
다행이도 한글의 경우는 Nori 한글 형태소 분석기를 이용하여 이 과정을 수행합니다.</p>

<blockquote>
  <p>자세한 내용은 Elasticsearch Document 를 참고해주세요!! <a href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.10/analysis-nori.html">Nori Analysis Plugin 구경하기</a></p>
</blockquote>

<hr />

<p>위 과정을 통해 저장된 토큰들을 통해 Search API 기능들을 수행합니다.</p>

<p>다음에는 query 를 통해 실제 예제로 찾아뵙겠습니다.</p>

<p>피드백은 항상 환영입니다.</p>

  <hr />
</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/redux/redux-1/">
          Redux 기본서!! (feat. react context hook)
          <small>11 Feb 2021</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/nestjs/nestjs-4-testing/">
          NestJS 블로그 만들기 - 리팩토링과 e2e 테스트!!
          <small>09 Feb 2021</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/nodejs/nodejs-1-what-is-nodejs/">
          Node.js 의 특징과 한계
          <small>01 Feb 2021</small>
        </a>
      </h3>
    </li>
    
  </ul>
</div>

</div>
  
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src="/public/js/script.js"></script>
  </body>
</html>
